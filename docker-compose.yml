# Description: Database-only mirror, as an alternative to 'default'
# Utilise directement les images MetaBrainz officielles (pas de build local nécessaire)

volumes:
  pgdata:
    driver: local
  dbdump:
    driver: local
  logs:
    driver: local

services:
  db:
    container_name: musicbrainz-db
    image: metabrainz/musicbrainz-docker-db:${POSTGRES_VERSION:-16}-build${DB_BUILD_SEQUENCE:-0}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    restart: unless-stopped
    command: postgres -c "shared_buffers=2048MB"
    env_file:
      - ./default/postgres.env
    shm_size: "2GB"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - dbdump:/media/dbdump:ro  # ✅ Volume partagé pour accéder aux dumps depuis PostgreSQL
    ports:
      - "5432:5432"

  musicbrainz:
    image: metabrainz/musicbrainz-docker-musicbrainz:${MUSICBRAINZ_SERVER_VERSION:-v-2025-10-13.0}-build${MUSICBRAINZ_BUILD_SEQUENCE:-1}
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "50"
    volumes:
      - dbdump:/media/dbdump:ro
      - logs:/logs
    restart: unless-stopped
    env_file:
      - ./default/postgres.env
    environment:
      - MUSICBRAINZ_BASE_FTP_URL=${MUSICBRAINZ_BASE_FTP_URL:-}
      - MUSICBRAINZ_BASE_DOWNLOAD_URL=${MUSICBRAINZ_BASE_DOWNLOAD_URL:-https://data.metabrainz.org/pub/musicbrainz}
      - MUSICBRAINZ_WEB_SERVER_HOST=${MUSICBRAINZ_WEB_SERVER_HOST:-localhost}
      - MUSICBRAINZ_WEB_SERVER_PORT=${MUSICBRAINZ_WEB_SERVER_PORT:-5000}
    command: load-crontab-only.sh
    depends_on:
      - db
      - redis

  redis:
    image: redis:3-alpine
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    restart: unless-stopped
    expose:
      - "6379"
